<!-- Is generated using AI -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rootblood // Chaotic Browser Linux</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap');
        body {
            font-family: 'Fira Code', monospace;
            background-color: #111827;
            color: #E5E7EB;
        }
        .terminal-container {
            height: 60vh;
        }
        .form-input {
            background-color: #1F2937;
            border: 1px solid #4B5563;
            color: #E5E7EB;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px #1e40af;
        }
        .btn {
            background-color: #3B82F6;
            transition: background-color 0.2s ease-in-out;
        }
        .btn:hover {
            background-color: #2563EB;
        }
        .btn-secondary {
            background-color: #4B5563;
        }
        .btn-secondary:hover {
            background-color: #6B7280;
        }
        .card {
            background-color: #1F2937;
            border: 1px solid #374151;
        }
        .console-log {
            background-color: #000;
            border: 1px solid #374151;
            color: #00ff00;
            height: 150px;
            overflow-y: scroll;
            font-size: 0.8rem;
        }
        .console-log p {
            margin: 0;
            padding: 2px 5px;
            border-bottom: 1px solid #1a1a1a;
        }
        .console-log .error {
            color: #ef4444;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center space-y-2">
            <h1 class="text-4xl md:text-6xl font-bold text-blue-400">rootblood</h1>
            <p class="text-md md:text-lg text-gray-400">A Chaotic Browser-Based Linux Environment</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Control Panel -->
            <div class="space-y-6">
                <!-- User Management -->
                <div class="card p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">1. User Management</h2>
                    <div class="space-y-3">
                        <input id="usernameInput" type="text" placeholder="Enter username (e.g., eva)" class="w-full form-input rounded p-2">
                        <div class="flex space-x-2">
                             <button onclick="createUser()" class="btn w-full text-white font-bold py-2 px-4 rounded">Create User</button>
                             <button onclick="loginUser()" class="btn-secondary w-full text-white font-bold py-2 px-4 rounded">Set Active User</button>
                        </div>
                    </div>
                </div>

                <!-- Directory Management -->
                <div class="card p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">2. Claim Directory in /global</h2>
                     <div class="space-y-3">
                        <input id="dirPathInput" type="text" placeholder="Enter directory path (e.g., my-project)" class="w-full form-input rounded p-2">
                        <button onclick="claimDirectory()" class="btn w-full text-white font-bold py-2 px-4 rounded">Claim Directory</button>
                    </div>
                </div>

                <!-- Session Launcher -->
                <div class="card p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">3. Launch Session</h2>
                    <div class="space-y-3">
                        <input id="sessionPathInput" type="text" placeholder="Target path in /global (optional)" class="w-full form-input rounded p-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="launchSession(false)" class="btn text-white font-bold py-2 px-4 rounded">Launch Personal Session</button>
                            <button onclick="launchSession(true)" class="btn-secondary text-white font-bold py-2 px-4 rounded">Launch as Guest</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contribution & Log Panel -->
            <div class="space-y-6">
                <div class="card p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">Contribution Management</h2>
                    <div class="flex space-x-2 mb-3">
                        <button onclick="checkContributions()" class="btn w-full text-white font-bold py-2 px-4 rounded">Check for Contributions</button>
                    </div>
                    <div id="contributionsList" class="space-y-2">
                        <!-- Contributions will be listed here -->
                    </div>
                </div>
                <div class="card p-4 rounded-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-600 pb-2">API Log</h2>
                    <div id="apiLog" class="console-log p-2 rounded">
                        <p>Welcome! System is ready.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal Display -->
        <div class="card p-4 rounded-lg">
            <h2 class="text-2xl font-bold mb-4">Terminal</h2>
            <div id="terminal" class="terminal-container bg-black rounded-md overflow-hidden">
                <iframe id="terminalFrame" class="w-full h-full border-0"></iframe>
            </div>
        </div>

    </div>

    <script>
        let activeUser = '';
        let currentSession = {
            containerName: null,
            heartbeatInterval: null
        };

        const API_BASE = 'http://127.0.0.1:5000';

        function logMessage(message, isError = false) {
            const log = document.getElementById('apiLog');
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                p.classList.add('error');
            }
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }

        async function apiCall(endpoint, method, body) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Unknown error');
                }
                return data;
            } catch (error) {
                logMessage(`API Error: ${error.message}`, true);
                throw error;
            }
        }
        
        function loginUser() {
            const username = document.getElementById('usernameInput').value;
            if (!username) {
                logMessage('Please enter a username to set as active user.', true);
                return;
            }
            activeUser = username;
            logMessage(`Active user set to: ${activeUser}`);
        }

        async function createUser() {
            const username = document.getElementById('usernameInput').value;
            if (!username) {
                logMessage('Please enter a username to create.', true);
                return;
            }
            try {
                const data = await apiCall('/users', 'POST', { username });
                logMessage(data.message);
                activeUser = username;
                logMessage(`Active user set to: ${activeUser}`);
            } catch (error) {
                // Error is already logged by apiCall
            }
        }

        async function claimDirectory() {
            if (!activeUser) {
                logMessage('Please set an active user before claiming a directory.', true);
                return;
            }
            const path = document.getElementById('dirPathInput').value;
            if (!path) {
                logMessage('Please enter a directory path to claim.', true);
                return;
            }
            try {
                const data = await apiCall('/directories/claim', 'POST', { username: activeUser, path });
                logMessage(data.message);
            } catch (error) {}
        }

        async function launchSession(isGuest = false) {
            let body = { is_guest: isGuest };
            if (!isGuest) {
                if (!activeUser) {
                    logMessage('Please set an active user for a personal session.', true);
                    return;
                }
                body.username = activeUser;
                const path = document.getElementById('sessionPathInput').value;
                if (path) {
                    body.path = path;
                }
            }

            try {
                logMessage('Requesting session...');
                const data = await apiCall('/session', 'POST', body);
                logMessage(data.message);
                
                const terminalFrame = document.getElementById('terminalFrame');
                terminalFrame.src = data.session_url;
                
                startHeartbeat(data.container_name);
            } catch (error) {}
        }
        
        function startHeartbeat(containerName) {
            if (currentSession.heartbeatInterval) {
                clearInterval(currentSession.heartbeatInterval);
            }
            
            if (!containerName) return;

            currentSession.containerName = containerName;
            
            currentSession.heartbeatInterval = setInterval(async () => {
                if (!currentSession.containerName) {
                    clearInterval(currentSession.heartbeatInterval);
                    return;
                }
                try {
                    await apiCall('/session/heartbeat', 'POST', { container_name: currentSession.containerName });
                    console.log(`Heartbeat sent for ${currentSession.containerName}`);
                } catch (error) {
                    logMessage(`Heartbeat failed for ${currentSession.containerName}. Session may have ended.`, true);
                    clearInterval(currentSession.heartbeatInterval);
                    currentSession.containerName = null;
                }
            }, 60 * 1000); // Send heartbeat every 60 seconds
        }

        async function checkContributions() {
            if (!activeUser) {
                logMessage('Please set an active user to check for contributions.', true);
                return;
            }
            try {
                const contributions = await apiCall(`/contributions/${activeUser}`, 'GET');
                const list = document.getElementById('contributionsList');
                list.innerHTML = '';
                if (contributions.length === 0) {
                    list.innerHTML = '<p class="text-gray-400">No pending contributions found.</p>';
                    return;
                }
                
                contributions.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-gray-800 rounded';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold">${c.contribution_id.substring(0,12)}...</p>
                            <p class="text-sm text-gray-400">For project: ${c.project_path}</p>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="mergeContribution('${c.contribution_id}')" class="btn text-xs py-1 px-2 rounded">Merge</button>
                            <button onclick="deleteContribution('${c.contribution_id}')" class="btn-secondary text-xs py-1 px-2 rounded">Reject</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (error) {}
        }

        async function mergeContribution(id) {
            try {
                const data = await apiCall('/contributions/merge', 'POST', { contribution_id: id });
                logMessage(data.message);
                checkContributions(); // Refresh the list
            } catch (error) {}
        }

        async function deleteContribution(id) {
            try {
                const data = await apiCall('/contributions/delete', 'POST', { contribution_id: id });
                logMessage(data.message);
                checkContributions(); // Refresh the list
            } catch (error) {}
        }

    </script>
</body>
</html>

